# Graphite Apache Virtual Host
#
# Generated by Chef
NameVirtualHost *:<%= node['graphite']['listen_port'] %>

# WSGISocketPrefix /var/run/wsgi #create this folder and make it writeable by the user apache runs as
<VirtualHost *:<%= node['graphite']['listen_port']%>>
	ServerName <%= node['graphite']['url'] %>
	<% unless node['graphite']['url_aliases'].empty? %>
	ServerAlias <%= [node['graphite']['url_aliases']].flatten.compact.join(" ") %>
	<% end %>
	DocumentRoot "<%= node['graphite']['doc_root'] %>"
	ErrorLog <%= node['graphite']['storage_dir'] %>/log/webapp/error.log
	CustomLog <%= node['graphite']['storage_dir'] %>/log/webapp/access.log common

	WSGIDaemonProcess graphite user=<%= @user %> processes=2 threads=3 display-name='%{GROUP}' inactivity-timeout=120
	WSGIProcessGroup graphite
	WSGIApplicationGroup %{GLOBAL}
	WSGIImportScript <%= node['graphite']['base_dir'] %>/conf/graphite.wsgi process-group=graphite application-group=%{GLOBAL}
	WSGIScriptAlias / <%= node['graphite']['base_dir'] %>/conf/graphite.wsgi

	Alias /content/ <%= node['graphite']['doc_root'] %>/content/
	<Location "/content/">
		SetHandler None
	</Location>

	<Location "/media/">
		SetHandler None
	</Location>

	# The graphite.wsgi file has to be accessible by apache. It won't
	# be visible to clients because of the DocumentRoot though.
	<Directory <%= node['graphite']['base_dir'] %>/conf/>
		Order deny,allow
		Allow from all
	</Directory>
</VirtualHost>